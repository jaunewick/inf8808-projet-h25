import * as d3 from "d3";
import React, { useEffect, useState } from "react";
import DBReader from "../../services/dbReader";
import SurvivalCalculator from "../../services/ProbabiltyCalculator";
import "./Pictograph.css";

const PictographFilters = () => {
  const [genderFilter, setGenderFilter] = useState("all");
  const [ageFilter, setAgeFilter] = useState("all");
  const [classFilter, setClassFilter] = useState("all");

  const createVisualization = (text, value) => {
    const svgDoc = d3
      .select("#visualization-container")
      .append("svg")
      .attr("width", 600)
      .attr("height", 130);

    svgDoc
      .append("defs")
      .append("g")
      .attr("id", `iconCustom${text}`)
      .append("path")
      .attr(
        "d",
        "M50 27C56.0751 27 61 22.0751 61 16C61 9.92487 56.0751 5 50 5C43.9249 5 39 9.92487 39 16C39 22.0751 43.9249 27 50 27ZM49.1264 28H49.1263H49.1238H49.1174H49.1161H49.1085H49.1037H49.1009H49.0933H49.0902H49.0857H49.0781H49.0768H49.0706H49.0636H49.063H49.0555H49.0506H49.048H49.0405H49.0377H49.033H49.0256H49.025H49.0181H49.0125H49.0107H49.0033H49.0001H48.996H48.9886H48.9879H48.9813H48.9758H48.974H48.9667H48.9639H48.9595H48.9523H48.9521H48.9451H48.9405H48.9379H48.9307H48.929H48.9236H48.9177H48.9165H48.9095H48.9066H48.9025H48.8956H48.8955H48.8885H48.8848H48.8816H48.8747H48.8741H48.8678H48.8635H48.861H48.8542H48.8531H48.8474H48.8429H48.8407H48.834H48.8328H48.8273H48.8229H48.8207H48.8141H48.8131H48.8076H48.8034H48.8011H48.7946H48.7939H48.7882H48.7846H48.7818H48.7755H48.7754H48.7692H48.7663H48.7629H48.7574H48.7567H48.7506H48.7486H48.7444H48.74H48.7384H48.7323H48.7315H48.7264H48.7232H48.7204H48.715H48.7145H48.7087H48.7069H48.7029H48.699H48.6972H48.6915H48.6912H48.6858H48.6835H48.6803H48.676H48.6747H48.6692H48.6687H48.6638H48.6614H48.6584H48.6543H48.6531H48.6479H48.6474H48.6427H48.6405H48.6375H48.6339H48.6324H48.6274H48.6273H48.6224H48.6209H48.6175H48.6146H48.6126H48.6084H48.6078H48.6031H48.6024H48.5984H48.5965H48.5938H48.5907H48.5893H48.5851H48.5848H48.5804H48.5796H48.576H48.5742H48.5717H48.5689H48.5675H48.5638H48.5633H48.5593H48.5588H48.5552H48.5539H48.5513H48.5491H48.5474H48.5445H48.5436H48.54H48.5398H48.5362H48.5356H48.5326H48.5314H48.529H48.5272H48.5256H48.5232H48.5222H48.5193H48.5189H48.5156H48.5155H48.5125H48.5119H48.5094H48.5083H48.5064H48.5049H48.5035H48.5016H48.5006H48.4984H48.4978H48.4954H48.4951H48.4925H48.4924H48.49H48.4896H48.4875H48.4869H48.4852H48.4842H48.4829H48.4818H48.4807H48.4794H48.4785H48.4771H48.4765H48.4749H48.4746H48.4729H48.4727H48.4709H48.4709H48.4692H48.4691H48.4676H48.4674H48.4661H48.4658H48.4646H48.4643H48.4633H48.4629H48.462H48.4616H48.4609H48.4604H48.4598H48.4593H48.4588H48.4583H48.4579H48.4575H48.4571H48.4567H48.4564H48.456H48.4558H48.4555H48.4553H48.455H48.4549H48.4546H48.4545H48.4544H48.4543H48.4542H48.4542H48.4542V28.0375C43.4617 28.2848 39.3076 29.7611 36.3357 32.6872C33.0567 35.9157 32 40.1373 32 44L32 62.5C32 65.2614 34.2386 67.5 37 67.5C37.5226 67.5 38.0265 67.4198 38.5 67.2711V90C38.5 92.7614 40.7386 95 43.5 95C46.2614 95 48.5 92.7614 48.5 90V64.9794H51.5V90C51.5 92.7614 53.7386 95 56.5 95C59.2614 95 61.5 92.7614 61.5 90V67.2711C61.9735 67.4198 62.4774 67.5 63 67.5C65.7614 67.5 68 65.2614 68 62.5V44C68 39.9453 66.6976 35.7701 63.4023 32.6302C60.2761 29.6514 55.9267 28.1464 50.7765 28.0102V28H50.7764H50.7764H50.7763H50.7762H50.7761H50.7759H50.7757H50.7754H50.7752H50.7749H50.7746H50.7742H50.7739H50.7734H50.7731H50.7725H50.7722H50.7715H50.7712H50.7704H50.7701H50.7691H50.7689H50.7677H50.7676H50.7662H50.7661H50.7646H50.763H50.7628H50.7612H50.7609H50.7594H50.7589H50.7574H50.7568H50.7554H50.7545H50.7533H50.7522H50.751H50.7496H50.7487H50.747H50.7463H50.7442H50.7438H50.7413H50.7411H50.7384H50.7383H50.7356H50.7351H50.7327H50.7318H50.7298H50.7283H50.7267H50.7248H50.7235H50.7211H50.7203H50.7172H50.7169H50.7135H50.7132H50.71H50.7091H50.7064H50.7048H50.7027H50.7004H50.6989H50.6959H50.6951H50.6912H50.6911H50.6871H50.6864H50.683H50.6814H50.6788H50.6763H50.6746H50.6711H50.6702H50.6658H50.6657H50.6613H50.6601H50.6568H50.6544H50.6521H50.6486H50.6474H50.6426H50.6426H50.6377H50.6365H50.6328H50.6302H50.6278H50.6238H50.6227H50.6175H50.6172H50.6123H50.6104H50.607H50.6035H50.6016H50.5965H50.5962H50.5907H50.5893H50.5851H50.582H50.5795H50.5744H50.5738H50.568H50.5668H50.5622H50.559H50.5563H50.551H50.5504H50.5444H50.5428H50.5383H50.5345H50.5322H50.5261H50.526H50.5198H50.5175H50.5135H50.5087H50.5071H50.5007H50.4997H50.4943H50.4906H50.4877H50.4814H50.4812H50.4745H50.4719H50.4679H50.4623H50.4611H50.4544H50.4526H50.4476H50.4426H50.4407H50.4338H50.4325H50.4268H50.4223H50.4198H50.4127H50.4118H50.4056H50.4012H50.3985H50.3913H50.3904H50.3841H50.3795H50.3768H50.3695H50.3684H50.3621H50.3571H50.3547H50.3473H50.3456H50.3398H50.3339H50.3323H50.3248H50.3221H50.3172H50.3101H50.3096H50.302H50.2979H50.2943H50.2866H50.2856H50.2788H50.2731H50.2711H50.2633H50.2603H50.2554H50.2476H50.2475H50.2397H50.2344H50.2318H50.2238H50.2211H50.2159H50.2079H50.2077H50.1999H50.1941H50.1918H50.1838H50.1803H50.1757H50.1676H50.1663H50.1595H50.1521H50.1513H50.1432H50.1378H50.135H50.1268H50.1232H50.1186H50.1104H50.1085H50.1021H50.0939H50.0935H50.092H50.0919H50.0917H50.0914H50.0914H50.091H50.091H50.0906H50.0905H50.09H50.0899H50.0893H50.0892H50.0885H50.0884H50.0877H50.0875H50.0867H50.0865H50.0857H50.0856H50.0854H50.0846H50.0841H50.0833H50.0828H50.082H50.0814H50.0806H50.0798H50.0791H50.0784H50.0782H50.0776H50.0773H50.0764H50.0759H50.0745H50.0741H50.0726H50.0723H50.0705H50.0704H50.069H50.0684H50.0683H50.0663H50.066H50.0641H50.0635H50.0631H50.0618H50.061H50.0607H50.0595H50.0583H50.0571H50.0556H50.0546H50.0527H50.0524H50.052H50.0497H50.0493H50.0476H50.0466H50.0466H50.0441H50.0437H50.0434H50.0408H50.04H50.0379H50.0366H50.0358H50.0348H50.033H50.032H50.0317H50.0293H50.0285H50.0275H50.0255H50.0252H50.0218H50.0215H50.0191H50.0184H50.0175H50.0161H50.0149H50.0133H50.0113H50.0108H50.009H50.0077H50.0046H50.0039H50.0024H50.0002H50H49.9963H49.994H49.9924H49.9884H49.9857H49.9843H49.9828H49.9802H49.9776H49.9773H49.976H49.9717H49.9689H49.9674H49.9658H49.963H49.9606H49.9585H49.9554H49.954H49.9522H49.9494H49.949H49.9447H49.9438H49.94H49.9355H49.9353H49.9333H49.9324H49.9304H49.9271H49.9255H49.9206H49.9187H49.9159H49.9156H49.9115H49.9105H49.9104H49.9054H49.902H49.9002H49.8997H49.8949H49.8936H49.8898H49.8896H49.8853H49.8843H49.8837H49.8789H49.8769H49.8734H49.8686H49.8684H49.8679H49.8678H49.8623H49.8603H49.8567H49.8522H49.852H49.8511H49.8471H49.8453H49.8436H49.8396H49.8367H49.8353H49.8337H49.8279H49.827H49.826H49.822H49.8215H49.8188H49.816H49.8105H49.81H49.8064H49.8051H49.8039H49.8022H49.7978H49.794H49.7917H49.7915H49.7858H49.7855H49.7844H49.7792H49.7776H49.7768H49.773H49.7694H49.7666H49.7639H49.7623H49.7612H49.7603H49.7539H49.753H49.748H49.7474H49.7449H49.7436H49.7409H49.7368H49.7344H49.7338H49.7286H49.7278H49.7235H49.7212H49.7206H49.7199H49.7146H49.7125H49.7079H49.7061H49.7045H49.7035H49.7012H49.6964H49.6944H49.6925H49.6884H49.6877H49.6837H49.6808H49.6805H49.6791H49.674H49.6725H49.6671H49.6659H49.6646H49.6642H49.6602H49.6567H49.6532H49.6529H49.6489H49.6462H49.6448H49.641H49.64H49.6392H49.6332H49.6322H49.6273H49.6255H49.6254H49.6251H49.618H49.6177H49.6148H49.6109H49.61H49.6065H49.6037H49.6025H49.6023H49.5965H49.5946H49.5904H49.5893H49.5877H49.587H49.5821H49.5794H49.5784H49.5748H49.5719H49.569H49.5675H49.5666H49.5644H49.5602H49.5569H49.555H49.5528H49.5505H49.5495H49.5455H49.5436H49.5421H49.5381H49.5347H49.5323H49.5322H49.5307H49.5274H49.5233H49.5212H49.5201H49.5158H49.5141H49.5129H49.5103H49.5084H49.5057H49.5009H49.4995H49.4985H49.4961H49.4934H49.4914H49.489H49.4859H49.4844H49.4786H49.4783H49.4773H49.4708H49.4704H49.4683H49.4634H49.4632H49.4607H49.4582H49.4566H49.4556H49.4497H49.4483H49.448H49.4433H49.4429H49.4404H49.4386H49.4362H49.4328H49.4295H49.429H49.4261H49.4251H49.4229H49.4196H49.4175H49.4163H49.4104H49.4098H49.4098H49.409H49.4033H49.4021H49.4013H49.3969H49.3945H49.3924H49.3921H49.3905H49.3868H49.3842H49.3837H49.3791H49.378H49.3754H49.3751H49.3718H49.3713H49.3667H49.3657H49.3636H49.3596H49.3589H49.3584H49.3559H49.3536H49.3503H49.3482H49.3476H49.3425H49.3423H49.3417H49.3404H49.3359H49.3345H49.3327H49.3301H49.3269H49.3263H49.3249H49.3244H49.3194H49.3188H49.3172H49.3132H49.3121H49.3103H49.3094H49.3077H49.3049H49.3022H49.3017H49.2979H49.2968H49.2944H49.2939H49.2915H49.2911H49.2863H49.2861H49.2844H49.2811H49.2788H49.2784H49.2778H49.276H49.2714H49.271H49.2706H49.266H49.2651H49.2632H49.2628H49.2611H49.259H49.2563H49.2551H49.2531H49.2516H49.2479H49.2473H49.2473H49.2469H49.2423H49.2416H49.2395H49.2378H49.2361H49.2334H49.2327H49.2318H49.2307H49.229H49.2255H49.2248H49.224H49.2206H49.2204H49.2177H49.2165H49.2163H49.2155H49.2124H49.2107H49.2085H49.2085H49.206H49.2046H49.2029H49.2015H49.2008H49.2008H49.1971H49.1935H49.193H49.1929H49.19H49.1888H49.1882H49.1865H49.1853H49.1848H49.1832H49.181H49.1799H49.1776H49.1773H49.1767H49.1738H49.1737H49.1736H49.1706H49.1704H49.1699H49.1677H49.1671H49.1649H49.1639H49.1622H49.1609H49.1595H49.1594H49.158H49.157H49.1553H49.1546H49.1545H49.1527H49.1522H49.1502H49.15H49.1478H49.1468H49.1457H49.1456H49.1452H49.1438H49.1435H49.1419H49.1415H49.1402H49.1396H49.1391H49.1385H49.1379H49.137H49.1363H49.1355H49.1348H49.1342H49.1334H49.1329H49.1322H49.1318H49.1314H49.1312H49.1311H49.1307H49.1301H49.1298H49.1292H49.129H49.1284H49.1283H49.1278H49.1277H49.1273H49.1272H49.1269H49.1268H49.1266H49.1265H49.1264H49.1264Z"
      );

    const numCols = 10;
    const numRows = 1;
    const xPadding = 0;
    const yPadding = 5;
    const hBuffer = 0;
    const wBuffer = 55;
    const myIndex = d3.range(numCols * numRows);

    svgDoc
      .append("g")
      .attr("id", `pictoLayer${text}`)
      .selectAll("use")
      .data(myIndex)
      .enter()
      .append("use")
      .attr("xlink:href", `#iconCustom${text}`)
      .attr("id", (d) => `icon${text}${d}`)
      .attr("x", (d) => {
        const remainder = d % numCols;
        return xPadding + remainder * wBuffer;
      })
      .attr("y", (d) => {
        const whole = Math.floor(d / numCols);
        return yPadding + whole * hBuffer;
      })
      .attr("class", (d) => (d < value ? "iconSelected" : "iconPlain"));
  };

  const updateVisualization = React.useCallback(async () => {
    d3.select("#visualization-container").html("");
    const result = await SurvivalCalculator.getSurvivalProbability({
      isMale: genderFilter === "all" ? null : genderFilter === "male",
      passengerClass: classFilter === "all" ? null : parseInt(classFilter),
      ageRange:
        ageFilter === "all" ? null : 
        ageFilter === "child" ? [0, 17] :
        ageFilter === "youngadult" ? [18, 24] :
        ageFilter === "adult" ? [25, 64] :
        ageFilter === "elderly" ? [65, 100] : null
    });
    
    createVisualization("user", result || 0);
  }, [genderFilter, ageFilter, classFilter]);

  useEffect(() => {
      updateVisualization();
  }, [
    genderFilter,
    ageFilter,
    classFilter,
    updateVisualization,
  ]);

  return (
    <div>
      <div className="filters">
        <div className="filter-group">
          <div className="filter-label">Genre</div>
          <select
            id="gender-filter"
            value={genderFilter}
            onChange={(e) => setGenderFilter(e.target.value)}
          >
            <option value="all">Tous</option>
            <option value="male">Homme</option>
            <option value="female">Femme</option>
          </select>
        </div>

        <div className="filter-group">
          <div className="filter-label">Âge</div>
          <select
            id="age-filter"
            value={ageFilter}
            onChange={(e) => setAgeFilter(e.target.value)}
          >
            <option value="all">Tous</option>
            <option value="child">0-17 ans</option>
            <option value="youngadult">18-25 ans</option>
            <option value="adult">25-64</option>
            <option value="elderly">65+</option>
          </select>
        </div>

        <div className="filter-group">
          <div className="filter-label">Classe</div>
          <select
            id="class-filter"
            value={classFilter}
            onChange={(e) => setClassFilter(e.target.value)}
          >
            <option value="all">Tous</option>
            <option value="1">1ère classe</option>
            <option value="2">2ème classe</option>
            <option value="3">3ème classe</option>
          </select>
        </div>
      </div>

      <div id="visualization-container"></div>
    </div>
  );
};

export default PictographFilters;
